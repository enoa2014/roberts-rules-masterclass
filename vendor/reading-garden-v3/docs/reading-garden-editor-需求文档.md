# Reading Garden Editor 需求文档

## 1. 文档信息
- 文档名称：Reading Garden Editor 需求文档
- 适用项目：`reading-garden-v3` 配套可视化编辑器
- 文档版本：v1.1
- 编制日期：2026-02-11
- 关联输入：
  - `reading-garden-v3-新规划翻译与评审.md`
  - `reading-garden-v3/data/*`
  - `reading-garden-v3/js/core/book-runtime.js`

## 2. 项目背景与目标

### 2.1 背景
`reading-garden-v3` 已具备互动阅读能力，但新增图书、维护数据、配置模块与发布部署仍需要较强技术能力，教师/家长独立完成成本高。

### 2.2 建设目标
构建本地运行、离线优先、AI能力可选的 `reading-garden-editor`，实现：
1. 通过可视化界面完成图书设计、模块配置和数据编辑。
2. 支持从零创建一本新书并本地预览。
3. 支持图书交换包导出与导入，并合并到本地书架。
4. 支持整站打包并发布到腾讯云 EdgeOne。
5. 支持 AI 增强能力（大语言模型、生图）但不强依赖。

### 2.3 运行策略
- 离线手工模式（默认）：不配置任何 AI 接口也可完整完成建书、导入、导出、发布。
- LLM 辅助模式（可选）：分析原文并给出模块建议或自动配置初稿。
- 图片增强模式（可选）：AI 生图、仅生成 prompt、emoji 替代、无图模式。

### 2.4 成功定义
- 非技术用户可在 10 分钟内创建并导出一本可运行的新书。
- A 用户导出的图书包，B 用户可导入并合并到本地书架后正常浏览。
- 整站导出包上传 EdgeOne 后可正常访问，关键页面无阻断错误。

## 3. 角色与利益相关方
- 产品负责人：定义范围、优先级和验收标准。
- 教师/家长（核心用户）：创建/编辑图书与模块内容。
- 内容运营/教研：审核文本质量与教学适配性。
- 前端工程师：实现编辑器、导入导出、校验与部署链路。
- 测试工程师：验证本地可用性、导入合并正确性和发布稳定性。

## 4. 范围定义

### 4.1 范围内（In Scope）
- 本地目录接入、结构校验、文件读写。
- 新书创建向导与书架管理。
- JSON Schema 校验与业务规则校验。
- 异构数据归一化与迁移提示。
- AI 文本辅助（可选）与 AI 生图能力（可选）。
- 图书交换包（单书）导入导出与冲突合并。
- 整站发布包导出、部署说明与导出前校验。
- 自动保存、恢复、备份与错误诊断。

### 4.2 范围外（Out of Scope）
- 云端实时协同编辑。
- 后端数据库与账号体系。
- 云端自动部署执行（仅提供可部署包与部署说明）。
- 重构 `reading-garden-v3` 各业务模块运行逻辑。

## 5. 业务流程需求
1. 用户打开编辑器，选择本地项目目录或创建新项目。
2. 编辑器扫描并校验数据，展示本地书架。
3. 用户创建新书或编辑已有书，配置模块并编辑内容。
4. 用户按需启用 LLM 辅助（模块建议/自动配置）和图片策略。
5. 用户本地预览并修正问题。
6. 用户可导出“图书交换包”给他人。
7. 他人导入图书包并与本地书架合并。
8. 用户导出“整站发布包”并上传 EdgeOne 发布。

## 6. 功能需求（FR）

### 6.1 项目接入与结构校验
| 编号 | 需求 | 优先级 | 验收标准 |
|------|------|--------|----------|
| FR-001 | 支持选择本地项目目录并建立会话 | Critical | 成功读取目录句柄并显示项目信息 |
| FR-002 | 校验关键结构（`index.html`、`data/`、`js/`、`css/`） | Critical | 缺失项可提示并阻断核心流程 |
| FR-003 | 浏览器能力检测（原生/降级） | Critical | 不支持 File System Access API 时提供降级方案 |

### 6.2 书架与建书能力
| 编号 | 需求 | 优先级 | 验收标准 |
|------|------|--------|----------|
| FR-004 | 显示本地书架（来源于 `data/books.json`） | Critical | 书架数据与目录真实状态一致 |
| FR-005 | 提供“新建一本书”向导 | Critical | 可生成最小可运行书籍骨架 |
| FR-006 | 支持编辑图书元数据与模块配置 | High | 保存后结构合法且可运行 |
| FR-007 | 支持从模板创建新书（默认模板/空白模板） | High | 新书可直接进入编辑与预览流程 |

### 6.3 数据加载、校验与归一化
| 编号 | 需求 | 优先级 | 验收标准 |
|------|------|--------|----------|
| FR-008 | 基于 JSON Schema 进行结构校验 | Critical | 错误信息含字段路径、原因、建议 |
| FR-009 | 读取时兼容 `characters.json` 双结构 | Critical | Cytoscape/扁平结构均可编辑 |
| FR-010 | 兼容 `chapters.json` 多根结构与多内容类型 | Critical | `string`/`string[]`/数组根均可处理 |
| FR-011 | 保存时输出统一规范结构 | Critical | 输出可被运行时和导出链路消费 |
| FR-012 | 检测旧格式并提供迁移与备份 | High | 用户可选择兼容读取或升级保存 |

### 6.4 模块数据编辑
| 编号 | 需求 | 优先级 | 验收标准 |
|------|------|--------|----------|
| FR-013 | 通用 JSON 表单编辑器支持嵌套对象/数组 | High | 常见数据文件均可打开编辑 |
| FR-014 | 提供专用编辑器（章节/人物/主题/时间线等） | High | 核心字段具备结构化操作 |
| FR-015 | 自动发现 `modules[].data` 类型并映射编辑器 | High | 新增模块类型可被识别并处理 |

### 6.5 AI 文本辅助（可选）
| 编号 | 需求 | 优先级 | 验收标准 |
|------|------|--------|----------|
| FR-016 | 配置 LLM 接口（多 Provider 适配） | High | 可保存 Provider、模型、超时等配置 |
| FR-017 | 导入原文后可执行“模块建议分析” | High | 输出建议模块、理由与置信度 |
| FR-018 | 支持“一键自动配置初稿” | High | 自动生成可编辑的模块配置草稿 |
| FR-019 | 无 LLM 时仍可手工完整配置 | Critical | 所有核心能力不依赖 LLM |

### 6.6 图片策略（可选）
| 编号 | 需求 | 优先级 | 验收标准 |
|------|------|--------|----------|
| FR-020 | 支持 AI 生图接口配置 | Medium | 可生成图片并纳入资源目录 |
| FR-021 | 支持 `prompt-only` 输出 | Medium | 生成并保存可复用 prompt 文件 |
| FR-022 | 支持 emoji 替代策略 | Medium | 无图字段可回落为 emoji 呈现 |
| FR-023 | 支持无图模式 | Medium | 关键流程与导出不因缺图失败 |

### 6.7 图书交换包导入导出
| 编号 | 需求 | 优先级 | 验收标准 |
|------|------|--------|----------|
| FR-024 | 支持导出单书交换包（`*.rgbook.zip`） | Critical | 包含 manifest、数据、资源、可选 AI 元信息 |
| FR-025 | 支持导入单书交换包并校验 | Critical | 校验失败时阻断导入并显示原因 |
| FR-026 | 支持导入冲突处理（覆盖/重命名/跳过/手动） | Critical | 冲突可追踪，处理结果可回放 |
| FR-027 | 导入后自动合并到本地书架索引 | Critical | 本地浏览与编辑立即可用 |

### 6.8 预览、整站导出与发布
| 编号 | 需求 | 优先级 | 验收标准 |
|------|------|--------|----------|
| FR-028 | 提供 iframe 实时预览与设备切换 | Medium | 支持桌面/平板/手机视口 |
| FR-029 | 导出前全量校验（结构/资源/引用） | Critical | 校验失败阻断导出并输出清单 |
| FR-030 | 导出整站发布包（`*.rgsite.zip`） | Critical | 解压后可作为静态站点根目录直接运行 |
| FR-031 | 生成 EdgeOne 部署说明与配置样例 | High | 用户可按文档完成部署并访问 |

### 6.9 保存、恢复与安全
| 编号 | 需求 | 优先级 | 验收标准 |
|------|------|--------|----------|
| FR-032 | 自动保存（防抖） + IndexedDB 快照 | High | 异常关闭后可恢复未提交内容 |
| FR-033 | 导入压缩包安全检查（路径穿越/文件大小） | Critical | 非法包被拒绝并提示安全原因 |
| FR-034 | 导出包中禁止携带 API Key 等敏感信息 | Critical | 安全扫描通过后才允许导出 |

## 7. 数据需求（DR）
| 编号 | 需求 | 说明 |
|------|------|------|
| DR-001 | 统一内部 Canonical 数据模型 | 屏蔽历史异构格式差异 |
| DR-002 | 多格式输入兼容 | 支持现有历史书籍数据读取 |
| DR-003 | 输出标准化 | 保存与导出输出统一结构 |
| DR-004 | 路径可追溯 | 记录资源引用关系并可做死链检测 |
| DR-005 | 模块类型可扩展 | 通过适配器扩展新数据类型 |
| DR-006 | 图书交换包清单化 | `manifest.json` 描述元数据、校验和、schemaVersion |
| DR-007 | AI 元信息可选持久化 | 记录提示词、模型、生成策略（可关闭） |

## 8. 非功能需求（NFR）
| 编号 | 需求 | 指标/标准 |
|------|------|-----------|
| NFR-001 | 性能 | 首次加载 < 2s；预览刷新 < 500ms |
| NFR-002 | 保存时延 | 单文件保存平均 < 100ms（本地） |
| NFR-003 | 可用性 | 无 AI 配置也可完成全流程 |
| NFR-004 | 兼容性 | Chrome/Edge 原生；Safari/Firefox 有降级路径 |
| NFR-005 | 可靠性 | 导出阻断式校验，避免无效发布包 |
| NFR-006 | 安全性 | 不执行用户输入脚本；导入包安全检查 |
| NFR-007 | 可维护性 | 模块职责清晰，适配器可扩展 |
| NFR-008 | 可测试性 | 关键流程具备单元/集成/E2E 覆盖 |
| NFR-009 | 可迁移性 | 导入导出支持跨设备、跨用户交换书籍 |

## 9. 约束与依赖

### 9.1 技术约束
- 保持纯静态前端架构，不引入后端服务。
- AI 能力为可选增强，核心流程不得依赖网络。
- 不修改 `reading-garden-v3` 运行时业务逻辑，仅增强内容生产和打包能力。

### 9.2 依赖项
- `Ajv`：JSON Schema 校验。
- `JSZip`：压缩包导入导出。
- `File System Access API`：原生目录读写。
- `IndexedDB`：恢复与缓存。
- 可选 LLM/生图 Provider 接口。

## 10. 验收标准（AR）
| 编号 | 验收项 | 验收标准 |
|------|--------|----------|
| AR-001 | 新建一本书 | 可通过向导创建并本地预览 |
| AR-002 | 异构数据兼容 | 覆盖 `totto-chan`、`wave`、`wonder`、`lord-of-the-flies` 的章节/人物差异 |
| AR-003 | AI 可选能力 | 配置 AI 时可出建议；不配置时全流程可用 |
| AR-004 | 图书交换包 | A 导出、B 导入后可浏览并加入本地书架 |
| AR-005 | 冲突合并 | ID/路径冲突可交互处理且结果可追踪 |
| AR-006 | 整站发布包 | 包上传 EdgeOne 后可访问且关键页面无 404 |
| AR-007 | 资源完整性 | 模块可初始化、控制台无阻断级错误 |

## 11. 里程碑建议（6周）
1. 第1周：基础设施与结构校验。
2. 第2周：归一化/迁移层与通用编辑器。
3. 第3周：新建书向导与专用编辑器首批能力。
4. 第4周：图书交换包导入导出与冲突合并。
5. 第5周：整站导出与 EdgeOne 发布闭环。
6. 第6周：AI 可选能力（文本建议/图片策略）与体验收口。

## 12. 主要风险与应对
- 风险：历史数据格式差异导致编辑行为不一致。  
  应对：先实现适配器和迁移层，再推进高级 UI。
- 风险：交换包导入合并破坏本地书架。  
  应对：manifest 校验 + 冲突策略 + 事务化回滚。
- 风险：导出包路径错误导致 EdgeOne 运行失败。  
  应对：导出前引用扫描 + 路径重写 + 冒烟验证。
- 风险：AI 接口不可用影响业务流程。  
  应对：AI 功能旁路化，默认手工模式可完整运行。

## 13. 需求追踪关系（摘要）
- 数据异构风险 -> FR-009/010/011/012, DR-001/002/003。
- 图书交换风险 -> FR-024/025/026/027, DR-006, AR-004/005。
- 发布稳定性风险 -> FR-029/030/031, DR-004, AR-006/007。
- AI 可选策略 -> FR-016~023, NFR-003。

