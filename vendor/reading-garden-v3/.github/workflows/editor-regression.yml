name: Editor Regression

on:
  push:
    branches:
      - master
    paths:
      - "index.html"
      - "book.html"
      - "js/**"
      - "css/**"
      - "data/**"
      - "package.json"
      - "reading-garden-editor/**"
      - "scripts/editor-regression.sh"
      - "scripts/editor-regression.mjs"
      - "scripts/edgeone-preflight.sh"
      - "scripts/edgeone-preflight.mjs"
      - "scripts/edgeone-preflight-selftest.sh"
      - ".github/workflows/editor-regression.yml"
  pull_request:
    paths:
      - "index.html"
      - "book.html"
      - "js/**"
      - "css/**"
      - "data/**"
      - "package.json"
      - "reading-garden-editor/**"
      - "scripts/editor-regression.sh"
      - "scripts/editor-regression.mjs"
      - "scripts/edgeone-preflight.sh"
      - "scripts/edgeone-preflight.mjs"
      - "scripts/edgeone-preflight-selftest.sh"
      - ".github/workflows/editor-regression.yml"
  workflow_dispatch:
    inputs:
      pack_stats_selected_books:
        description: "Optional subset books for packStats, comma-separated (e.g. totto-chan,wave)"
        required: false
        default: "totto-chan,wave"
      pack_stats_require_valid_selection:
        description: "Fail when selected book IDs are invalid (true/false)"
        required: false
        default: "true"
      pack_stats_max_missing_assets:
        description: "Global max allowed missing assets for subset modes (non-negative integer)"
        required: false
        default: "1"
      pack_stats_max_missing_assets_subset_balanced:
        description: "Max allowed missing assets in subset-balanced (non-negative integer, empty to inherit global)"
        required: false
        default: ""
      pack_stats_max_missing_assets_subset_minimal:
        description: "Max allowed missing assets in subset-minimal (non-negative integer, empty to inherit global)"
        required: false
        default: ""
      pack_stats_max_missing_book_module:
        description: "Max allowed missing book-module assets (non-negative integer)"
        required: false
        default: "0"
      pack_stats_max_missing_book_cover:
        description: "Max allowed missing book-cover assets (non-negative integer, empty to disable)"
        required: false
        default: ""
      pack_stats_max_missing_file_ref:
        description: "Max allowed missing file-ref assets (non-negative integer, empty to disable)"
        required: false
        default: ""
      pack_stats_max_missing_unclassified:
        description: "Max allowed missing unclassified assets (non-negative integer, empty to disable)"
        required: false
        default: ""
      pack_stats_category_threshold_preset:
        description: "Category threshold preset (custom/balanced/strict)"
        required: false
        default: "custom"

jobs:
  editor-regression:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Run Editor Regression
        env:
          EDITOR_REGRESSION_REPORT: tmp/editor-regression-report.json
          EDITOR_PACK_STATS_SELECTED_BOOKS: ${{ github.event_name == 'workflow_dispatch' && inputs.pack_stats_selected_books || 'totto-chan,wave' }}
          EDITOR_PACK_STATS_REQUIRE_VALID_SELECTION: ${{ github.event_name == 'workflow_dispatch' && inputs.pack_stats_require_valid_selection || 'true' }}
          EDITOR_PACK_STATS_MAX_MISSING_ASSETS: ${{ github.event_name == 'workflow_dispatch' && inputs.pack_stats_max_missing_assets || '1' }}
          EDITOR_PACK_STATS_MAX_MISSING_ASSETS_SUBSET_BALANCED: ${{ github.event_name == 'workflow_dispatch' && inputs.pack_stats_max_missing_assets_subset_balanced || '' }}
          EDITOR_PACK_STATS_MAX_MISSING_ASSETS_SUBSET_MINIMAL: ${{ github.event_name == 'workflow_dispatch' && inputs.pack_stats_max_missing_assets_subset_minimal || '' }}
          EDITOR_PACK_STATS_MAX_MISSING_BOOK_MODULE: ${{ github.event_name == 'workflow_dispatch' && inputs.pack_stats_max_missing_book_module || '0' }}
          EDITOR_PACK_STATS_MAX_MISSING_BOOK_COVER: ${{ github.event_name == 'workflow_dispatch' && inputs.pack_stats_max_missing_book_cover || '' }}
          EDITOR_PACK_STATS_MAX_MISSING_FILE_REF: ${{ github.event_name == 'workflow_dispatch' && inputs.pack_stats_max_missing_file_ref || '' }}
          EDITOR_PACK_STATS_MAX_MISSING_UNCLASSIFIED: ${{ github.event_name == 'workflow_dispatch' && inputs.pack_stats_max_missing_unclassified || '' }}
          EDITOR_PACK_STATS_CATEGORY_THRESHOLD_PRESET: ${{ github.event_name == 'workflow_dispatch' && inputs.pack_stats_category_threshold_preset || 'custom' }}
        run: ./scripts/editor-regression.sh

      - name: Run EdgeOne Preflight Self-Test
        env:
          EDGEONE_PREFLIGHT_SELFTEST_REPORT: tmp/edgeone-preflight-selftest-report.json
        run: ./scripts/edgeone-preflight-selftest.sh

      - name: Summarize packStats
        if: always()
        run: |
          node <<'NODE'
          const fs = require("node:fs");
          const reportPath = "tmp/editor-regression-report.json";
          if (!fs.existsSync(reportPath)) process.exit(0);

          const report = JSON.parse(fs.readFileSync(reportPath, "utf8"));
          const stats = report.packStats
            || report.checks?.find((item) => item?.name === "pack-size-stats")?.details;
          if (!stats) process.exit(0);

          const selection = stats.selection || {};
          const selected = Array.isArray(stats.sampleSelectedBookIds) ? stats.sampleSelectedBookIds : [];
          const missing = Array.isArray(selection.missingBookIds) ? selection.missingBookIds : [];
          const invalidFormat = Array.isArray(selection.invalidFormatBookIds) ? selection.invalidFormatBookIds : [];
          const ratio = stats.comparePercent || {};
          const missingAssets = Number(stats.subsetMinimal?.missingAssets ?? 0);
          const missingAssetsAlert = missingAssets > 0 ? "warning" : "ok";
          const missingByCategory = stats.subsetMinimal?.missingAssetsByCategory || {};
          const categorySummary = Object.entries(missingByCategory)
            .map(([k, v]) => `${k}:${Number(v || 0)}`)
            .join(", ") || "(none)";
          const threshold = stats.missingAssetsThreshold || {};
          const thresholdText = threshold.enabled ? String(threshold.maxMissingAssets) : "disabled";
          const thresholdByMode = stats.missingAssetsThresholdsByMode || {};
          const thresholdBalanced = thresholdByMode["subset-balanced"] || {};
          const thresholdMinimal = thresholdByMode["subset-minimal"] || {};
          const thresholdBalancedText = thresholdBalanced.enabled ? String(thresholdBalanced.maxMissingAssets) : "disabled";
          const thresholdMinimalText = thresholdMinimal.enabled ? String(thresholdMinimal.maxMissingAssets) : "disabled";
          const categoryThresholds = stats.missingAssetsCategoryThresholds || {};
          const categoryThresholdPreset = String(stats.missingAssetsCategoryThresholdPreset || "custom");
          const moduleThreshold = categoryThresholds["book-module"] || {};
          const coverThreshold = categoryThresholds["book-cover"] || {};
          const fileRefThreshold = categoryThresholds["file-ref"] || {};
          const unclassifiedThreshold = categoryThresholds.unclassified || {};
          const moduleThresholdText = moduleThreshold.enabled ? String(moduleThreshold.maxMissingAssets) : "disabled";
          const coverThresholdText = coverThreshold.enabled ? String(coverThreshold.maxMissingAssets) : "disabled";
          const fileRefThresholdText = fileRefThreshold.enabled ? String(fileRefThreshold.maxMissingAssets) : "disabled";
          const unclassifiedThresholdText = unclassifiedThreshold.enabled ? String(unclassifiedThreshold.maxMissingAssets) : "disabled";
          const missingBookModule = Number(missingByCategory["book-module"] || 0);
          const missingBookCover = Number(missingByCategory["book-cover"] || 0);
          const missingFileRef = Number(missingByCategory["file-ref"] || 0);
          const missingUnclassified = Number(missingByCategory.unclassified || 0);
          const missingBookModuleAlert = missingBookModule > 0 ? "warning" : "ok";
          const missingBookCoverAlert = missingBookCover > 0 ? "warning" : "ok";
          const missingFileRefAlert = missingFileRef > 0 ? "warning" : "ok";
          const missingUnclassifiedAlert = missingUnclassified > 0 ? "warning" : "ok";
          const lines = [
            "### packStats Summary",
            "",
            `- mode: \`${selection.mode || "unknown"}\``,
            `- require valid selection: \`${String(stats.requireValidSelection ?? false)}\``,
            `- max missing-assets threshold: \`${thresholdText}\``,
            `- max missing-assets subset-balanced: \`${thresholdBalancedText}\``,
            `- max missing-assets subset-minimal: \`${thresholdMinimalText}\``,
            `- category threshold preset: \`${categoryThresholdPreset}\``,
            `- max book-module threshold: \`${moduleThresholdText}\``,
            `- max book-cover threshold: \`${coverThresholdText}\``,
            `- max file-ref threshold: \`${fileRefThresholdText}\``,
            `- max unclassified threshold: \`${unclassifiedThresholdText}\``,
            `- selected: \`${selected.join(", ") || "(none)"}\``,
            `- missing requested: \`${missing.join(", ") || "(none)"}\``,
            `- invalid format IDs: \`${invalidFormat.join(", ") || "(none)"}\``,
            `- missing assets (subset-minimal): ${missingAssets} (${missingAssetsAlert})`,
            `- missing book-module assets: ${missingBookModule} (${missingBookModuleAlert})`,
            `- missing book-cover assets: ${missingBookCover} (${missingBookCoverAlert})`,
            `- missing file-ref assets: ${missingFileRef} (${missingFileRefAlert})`,
            `- missing unclassified assets: ${missingUnclassified} (${missingUnclassifiedAlert})`,
            `- missing assets by category: ${categorySummary}`,
            `- full bytes: ${stats.full?.totalBytes ?? 0}`,
            `- subset-balanced bytes: ${stats.subsetBalanced?.totalBytes ?? 0}`,
            `- subset-minimal bytes: ${stats.subsetMinimal?.totalBytes ?? 0}`,
            `- subset-balanced/full: ${ratio.subsetBalancedVsFull ?? 0}%`,
            `- subset-minimal/full: ${ratio.subsetMinimalVsFull ?? 0}%`,
          ];

          const summaryPath = process.env.GITHUB_STEP_SUMMARY;
          if (summaryPath) {
            fs.appendFileSync(summaryPath, `${lines.join("\n")}\n`, "utf8");
          }
          NODE

      - name: Upload Regression Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: editor-regression-report
          path: |
            tmp/editor-regression-report.json
            tmp/edgeone-preflight-selftest-report.json
          if-no-files-found: warn
