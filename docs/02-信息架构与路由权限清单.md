# 信息架构与路由权限清单

## 1. 用户角色

| 角色 | 代码 | 获取方式 |
|------|------|---------|
| 游客 | `visitor` | 未登录 |
| 已注册 | `registered` | 注册/登录后的默认角色 |
| 学员 | `student` | 输入有效邀请码 |
| 教师 | `teacher` | 管理员授予 |
| 管理员 | `admin` | 系统初始化或管理员授予 |
| 封禁 | `blocked` | 管理员设置 |

### 状态流转

```text
visitor --注册/登录--> registered --邀请码--> student
student/registered --管理员封禁--> blocked
blocked --管理员解封--> registered 或 student
```

---

## 2. 页面信息架构

### 2.1 公开区域

| 页面 | 路由 | 说明 |
|------|------|------|
| 首页 | `/` | 课程价值主张、CTA、亮点 |
| 课程总览 | `/course` | 2+8+15 结构地图 |
| 关于与报名 | `/about` | 课程介绍、报名方式 |
| FAQ | `/faq` | 常见问题 |
| 登录 | `/login` | 首发用户名密码登录 |
| 注册 | `/register` | 用户名+密码注册 |

### 2.2 过渡区域（需登录）

| 页面 | 路由 | 说明 |
|------|------|------|
| 邀请码输入 | `/invite` | `registered` 输入邀请码升级资格 |
| 个人资料（可选） | `/profile` | 个人基础信息 |

### 2.3 学员区域（需 `student` 及以上）

| 页面 | 路由 | 说明 |
|------|------|------|
| 议事规则首页 | `/rules` | 模块入口 |
| 议事规则详情 | `/rules/[slug]` | 课次详情 |
| 阅读探究 | `/reading` | 阅读站入口（先嵌入） |
| 阅读子页 | `/reading/[bookSlug]` | 书目详情 |
| 工具库 | `/tools` | 15 个思考工具 |
| 工具详情 | `/tools/[slug]` | 工具详情 |
| 课堂互动 | `/interact` | 创建/加入课堂 |
| 课堂会话 | `/interact/[sessionId]` | 实时互动界面 |
| 作业与复盘 | `/homework` | 作业列表与提交入口 |
| 作业提交 | `/homework/submit/[lessonId]` | 提交作业 |
| 资源中心 | `/resources` | 模板下载 |
| 留言讨论 | `/discussion` | 发帖/评论 |

### 2.4 管理区域

| 页面 | 路由 | 可用角色 |
|------|------|---------|
| 管理后台首页 | `/admin` | `teacher`, `admin` |
| 学员管理 | `/admin/users` | `admin` |
| 邀请码管理 | `/admin/invites` | `admin` |
| 课堂管理 | `/admin/sessions` | `teacher`, `admin` |
| 作业批阅 | `/admin/assignments` | `teacher`, `admin` |
| 留言治理 | `/admin/moderation` | `teacher`, `admin` |

---

## 3. 路由权限矩阵

`✅` 可访问 | `→login` 跳登录 | `→invite` 跳邀请码页 | `→home` 跳首页 | `🚫` 拒绝

| 路由 | visitor | registered | student | teacher | admin | blocked |
|------|:-------:|:----------:|:-------:|:-------:|:-----:|:-------:|
| `/` | ✅ | ✅ | ✅ | ✅ | ✅ | ✅ |
| `/course` | ✅ | ✅ | ✅ | ✅ | ✅ | ✅ |
| `/about` | ✅ | ✅ | ✅ | ✅ | ✅ | ✅ |
| `/faq` | ✅ | ✅ | ✅ | ✅ | ✅ | ✅ |
| `/login` | ✅ | →home | →home | →home | →home | ✅ |
| `/register` | ✅ | →home | →home | →home | →home | ✅ |
| `/invite` | →login | ✅ | →home | →home | →home | 🚫 |
| `/profile` | →login | ✅ | ✅ | ✅ | ✅ | 🚫 |
| `/rules/*` | →login | →invite | ✅ | ✅ | ✅ | 🚫 |
| `/reading/*` | →login | →invite | ✅ | ✅ | ✅ | 🚫 |
| `/tools/*` | →login | →invite | ✅ | ✅ | ✅ | 🚫 |
| `/interact/*` | →login | →invite | ✅ | ✅ | ✅ | 🚫 |
| `/homework/*` | →login | →invite | ✅ | ✅ | ✅ | 🚫 |
| `/resources/*` | →login | →invite | ✅ | ✅ | ✅ | 🚫 |
| `/discussion/*` | →login | →invite | ✅ | ✅ | ✅ | 🚫 |
| `/admin` | →login | →home | →home | ✅ | ✅ | 🚫 |
| `/admin/users` | →login | →home | →home | →home | ✅ | 🚫 |
| `/admin/invites` | →login | →home | →home | →home | ✅ | 🚫 |
| `/admin/sessions` | →login | →home | →home | ✅ | ✅ | 🚫 |
| `/admin/assignments` | →login | →home | →home | ✅ | ✅ | 🚫 |
| `/admin/moderation` | →login | →home | →home | ✅ | ✅ | 🚫 |

---

## 4. proxy（原 middleware）规则伪代码

> 说明：项目基于 Next.js 16，路由拦截文件使用 `proxy.ts`（官方从 `middleware.ts` 迁移而来）。
> 因此仓库中没有 `middleware.ts` 是预期行为，不代表未做鉴权。

```text
if path in publicRoutes:
  allow

if no session:
  redirect /login?callbackUrl=path

if role == blocked:
  if path in publicRoutes or path in ['/login', '/register']:
    allow
  else:
    redirect /login?error=blocked

if path in ['/login', '/register'] and role != blocked:
  redirect /

if path in ['/invite', '/profile']:
  if path == '/invite' and role != registered:
    redirect /
  else:
    allow

if path startsWith '/admin':
  if path in ['/admin/users', '/admin/invites'] and role != admin:
    redirect /
  if role not in [teacher, admin]:
    redirect /
  allow

if role == registered:
  redirect /invite

allow
```

---

## 5. API 权限清单

| API 路由 | 方法 | 最低角色 |
|----------|------|---------|
| `/api/auth/register` | POST | 无 |
| `/api/auth/[...nextauth]` | ALL | 无 |
| `/api/invite/verify` | POST | `registered` |
| `/api/assignments` | GET/POST | `student` |
| `/api/assignments/[id]/review` | PATCH | `teacher` |
| `/api/feedbacks` | POST | `student` |
| `/api/discussion/posts` | GET/POST | `student` |
| `/api/discussion/comments` | GET/POST | `student` |
| `/api/admin/moderation/*` | POST/PATCH | `teacher` |
| `/api/interact/*` | ALL | `student`（其中创建课堂仅 `teacher/admin`） |
| `/api/admin/*` | ALL | `teacher/admin`（部分仅 `admin`） |

> 短信登录相关 API（`/api/sms/*`）属于 MVP+1，不计入首发接口清单。
