# 详细设计与任务拆解

> 目标：把“需求文档 + 实施路线”转成可直接开发执行的设计与任务清单。
> 协作策略：后端与基础设施由 Codex 主导，前端页面与交互实现由 Gemini 3 Pro 主导。

## 快速导航

- 文档总索引：`docs/00-文档索引.md`
- 里程碑：`docs/09-实施路线与里程碑.md`
- API 合同：`docs/04-API合同.md`
- 数据库设计：`docs/03-数据库设计与迁移策略.md`
- Gemini 前端交接：`docs/11-Gemini3Pro前端交接包.md`

## 1. 设计边界

- 首发必须完成：用户名密码登录、邀请码资格、课程内容、阅读站嵌入、课堂互动、作业反馈、留言治理、Docker 部署。
- 首发不包含：短信登录、微信小程序、支付。
- 并发目标：单课堂 30 人，优先一致性而非极限吞吐。

---

## 2. 系统总体设计

## 2.1 逻辑架构

```text
Browser (PC/Mobile/WeChat WebView)
  -> Next.js App Router
    -> Route Handlers (/api/*)
      -> Service Layer
        -> Repository (Drizzle)
          -> SQLite (data/course.db)

实时链路：
Browser EventSource <- /api/interact/sessions/{id}/stream (SSE)
```

## 2.2 部署架构

```text
User -> CDN(EdgeOne/ESA optional) -> Nginx -> Next.js container
                                              -> SQLite volume (./data)
```

## 2.3 模块划分

| 模块 | 目录建议 | 职责 |
|------|---------|------|
| 认证模块 | `lib/auth/*`, `app/(auth)/*` | 注册登录、Session 注入、角色判断 |
| 资格模块 | `lib/invite/*`, `app/invite/*`, `app/api/invite/*` | 邀请码核销、角色升级 |
| 课程内容模块 | `app/(public)/*`, `app/rules/*`, `app/tools/*`, `app/resources/*` | 内容展示与访问控制 |
| 阅读模块 | `app/reading/*`, `public/reading-legacy/*` | 首发嵌入，后续重构 |
| 互动模块 | `lib/interact/*`, `app/interact/*`, `app/api/interact/*` | 会话、举手、计时、投票、SSE |
| 课后模块 | `app/homework/*`, `app/api/assignments/*`, `app/api/feedbacks/*` | 作业与反馈 |
| 讨论治理模块 | `app/discussion/*`, `app/api/discussion/*`, `app/api/admin/moderation/*` | 留言、评论、治理日志 |
| 管理模块 | `app/admin/*`, `app/api/admin/*` | 角色管理、邀请码管理、治理面板 |
| 基础设施模块 | `docker/*`, `scripts/*`, `app/api/health` | 部署、健康检查、备份 |

---

## 3. 关键设计细节

## 3.1 认证与鉴权

1. 登录方式：首发仅 `username + password`。
2. Session：NextAuth credentials + HttpOnly Cookie。
3. middleware：

- 公开路由放行。
- 未登录访问受限路由跳转 `/login`。
- `registered` 访问受限路由跳转 `/invite`。
- `blocked` 拒绝所有受限路由。
- 修复 `/invite` 死循环：`registered` 必须可直接访问 `/invite`。

## 3.2 邀请码核销一致性

- 使用 `BEGIN IMMEDIATE` 事务。
- 条件更新 `invite_codes.used_count`，并检查 `changes() == 1`。
- 插入 `invite_code_uses` 与更新 `users.role` 在同一事务内完成。
- 失败时回滚并返回明确错误码（`CODE_EXPIRED`/`CODE_EXHAUSTED` 等）。

## 3.3 课堂互动一致性模型

- 状态源：数据库（不是内存）。
- SSE 只承担广播，不承担最终状态保存。
- 举手幂等：同一课堂同一用户只能有一条 open 记录（唯一索引）。
- 投票幂等：同一用户重复提交视为覆盖更新。
- 课堂结束时：禁止后续举手、投票、计时写入。

## 3.4 留言治理策略

- 发帖/评论发布即显示。
- 教师/管理员可执行 `hide/delete/block`。
- 所有治理动作写 `moderation_logs`，含操作者、目标、原因、时间。

## 3.5 阅读站嵌入策略

- 首发：`iframe src=/reading-legacy/index.html`。
- 受控入口：仅通过 `/reading/*` 访问。
- 后续：按书目逐步替换为 Next.js 页面。

## 3.6 文件与附件

- 作业附件首发可存本地目录（例如 `uploads/`）。
- 路径入库 `assignments.file_path`。
- Nginx/应用层限制上传大小与类型。

---

## 4. 前后端契约与协作边界

## 4.1 Codex 负责

1. 数据库 schema 与 migration。
2. API Route Handlers 与 Service 层。
3. middleware 与角色权限守卫。
4. SSE 流接口与广播机制。
5. Docker 部署脚本、健康检查、备份恢复。
6. 集成测试与回归脚本。

## 4.2 Gemini 3 Pro 负责

1. 页面 UI 实现（公开区、学员区、管理区）。
2. 交互组件实现（课堂页面、投票面板、讨论区、作业表单）。
3. 响应式适配与微信内浏览体验。
4. 前端表单校验、错误提示、空态设计。
5. 与 API 对接（按 `docs/04-API合同.md`）。

## 4.3 接口冻结策略

- API 先冻结核心路径：认证、邀请码、互动、作业、讨论、治理。
- 任何接口变更必须先更新 `docs/04-API合同.md` 再改代码。

---

## 5. 任务拆解（WBS）

## 5.1 P0（必须先做）

| ID | 任务 | Owner | 依赖 | 产出 | 验收 |
|----|------|-------|------|------|------|
| P0-01 | 初始化 Next.js + Drizzle + NextAuth | Codex | 无 | 项目骨架 | 本地可启动 |
| P0-02 | 实现 users/invite/core 表与迁移 | Codex | P0-01 | migration 文件 | 可建库成功 |
| P0-03 | 实现注册登录 + middleware + /invite 流程（API + 最小可用页面壳） | Codex | P0-02 | auth API + 页面最小壳 | registered 可到 invite（Gemini 在 FE-B1 替换完整 UI） |
| P0-04 | 实现邀请码事务核销 | Codex | P0-03 | `POST /api/invite/verify` | 并发核销正确 |
| P0-05 | 搭建公开页/课程页/FAQ 基础壳 | Gemini | P0-01 | 页面组件 | 路由可访问 |
| P0-06 | 阅读站整体嵌入页 | Gemini | P0-05 | `/reading` 页面 | student 可访问 |
| P0-07 | Dockerfile + compose + health | Codex | P0-01 | 容器部署脚本 | compose 启动成功 |

## 5.2 P1（核心业务）

| ID | 任务 | Owner | 依赖 | 产出 | 验收 |
|----|------|-------|------|------|------|
| P1-01 | 互动表结构（class_sessions/hand/poll/timer） | Codex | P0-02 | migration | 表可用 |
| P1-02 | 互动 API（会话/举手/计时/投票） | Codex | P1-01 | `/api/interact/*` | 状态机通过 |
| P1-03 | SSE stream 与事件广播 | Codex | P1-02 | stream handler | 多端同步 |
| P1-04 | 课堂互动 UI（教师端/学员端） | Gemini | P1-02 | `/interact/*` 页面 | 全流程跑通 |
| P1-05 | 作业与反馈 API | Codex | P0-02 | `/api/assignments` `/api/feedbacks` | 数据入库 |
| P1-06 | 作业与反馈页面 | Gemini | P1-05 | `/homework` 页面 | 提交可用 |
| P1-07 | 讨论与治理 API | Codex | P0-02 | discussion + moderation API | 日志可追溯 |
| P1-08 | 讨论区与治理前端页面 | Gemini | P1-07 | `/discussion` `/admin/moderation` | 可操作 |

## 5.3 P2（上线增强）

| ID | 任务 | Owner | 依赖 | 产出 | 验收 |
|----|------|-------|------|------|------|
| P2-01 | 管理后台整合（用户/邀请码/作业） | Gemini+Codex | P1-05 | `/admin/*` | 权限正确 |
| P2-02 | 自动化测试补齐 | Codex | 全部 | Vitest/Playwright | 回归通过 |
| P2-03 | 阅读站逐步重构第 1 批 | Gemini | P0-06 | 新 `/reading` 组件页 | 与 legacy 等效 |

---

## 6. 周度执行节奏（建议）

| 周次 | 目标 | 关键交付 |
|------|------|---------|
| Week 1 | 跑通认证与资格链路 | P0-01 ~ P0-04 |
| Week 2 | 上线课程内容与阅读入口 + Docker | P0-05 ~ P0-07 |
| Week 3 | 完成课堂互动链路 | P1-01 ~ P1-04 |
| Week 4 | 完成课后闭环与治理 | P1-05 ~ P1-08 |
| Week 5 | 联调、压测、上线准备 | P2-01 ~ P2-02 |

---

## 7. 前后端联调清单

1. 接口字段命名统一（camelCase）。
2. 错误码按合同返回。
3. 页面空态与错误态必须覆盖。
4. 角色切换（registered/student/teacher/admin/blocked）逐角色冒烟。
5. SSE 断线重连与快照恢复验证。
6. Docker 环境下回归一次完整主流程。

---

## 8. Definition of Done

- 文档：涉及模块的 API、状态机、测试用例已更新。
- 代码：通过 lint/build，无严重警告。
- 测试：主流程 + 越权 + 并发关键用例通过。
- 运维：`docker compose up -d` 可用，备份恢复已演练。
