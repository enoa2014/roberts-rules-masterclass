# 课堂互动状态机

> 原则：状态以数据库为准，SSE 仅用于实时广播。不得只存内存导致重启丢失关键互动数据。

## 1. 课堂会话状态（`class_sessions.status`）

```text
pending --开始课堂--> active --结束课堂--> ended
pending --直接结束--> ended
ended 为终态
```

| 当前状态 | 目标状态 | 触发者 | 条件 |
|---------|---------|--------|------|
| `pending` | `active` | `teacher/admin`（创建者或管理者） | 无 |
| `pending` | `ended` | `teacher/admin` | 无 |
| `active` | `ended` | `teacher/admin` | 无 |
| `ended` | - | - | 禁止变更 |

---

## 2. 举手队列状态（`hand_raises.status`）

```text
queued --教师点名--> speaking --结束发言--> done
queued --学员取消--> cancelled
speaking --教师取消--> cancelled
```

| 操作 | 触发者 | 状态变化 | 广播事件 |
|------|--------|---------|---------|
| 举手 | `student+` | 新增 `queued` | `hand_raised` |
| 取消举手 | 本人/教师 | `queued -> cancelled` | `hand_cancelled` |
| 指定发言 | `teacher/admin` | `queued -> speaking` | `hand_picked` |
| 结束发言 | `teacher/admin` | `speaking -> done` | `hand_dismissed` |
| 清空队列 | `teacher/admin` | `queued/speaking -> cancelled` | `hand_queue_cleared` |

### 幂等与一致性

- 同一学员在同一课堂同时只能有一条 `queued/speaking` 记录（唯一索引保证）
- 课堂 `ended` 后禁止新增举手

---

## 3. 发言计时状态（`speech_timers`）

```text
idle --start--> running --stop/timeout--> idle
```

### 约束

- 同一课堂同一时刻只允许一个活动计时器
- `start` 新计时时，需先关闭旧计时（事务内处理）
- 计时结束写 `ended_at`，并广播 `timer_stopped` 或 `timer_timeout`

| 操作 | 触发者 | 行为 | 广播事件 |
|------|--------|------|---------|
| `start` | `teacher/admin` | 写入计时记录（started） | `timer_started` |
| `stop` | `teacher/admin` | 更新记录 `ended_at` | `timer_stopped` |
| `timeout` | 系统任务 | 到时后自动结束 | `timer_timeout` |

---

## 4. 投票状态（`polls.status`）

```text
open --关闭投票--> closed
closed 为终态
```

| 操作 | 触发者 | 条件 | 行为 | 广播事件 |
|------|--------|------|------|---------|
| 创建投票 | `teacher/admin` | 课堂为 `active` | 新建 `polls` + `poll_options` | `vote_started` |
| 提交投票 | `student+` | `polls.status=open` | 覆盖写 `poll_votes` | `vote_updated` |
| 关闭投票 | `teacher/admin` | `polls.status=open` | 更新为 `closed` | `vote_result` |

### 幂等规则

- 同用户重复提交视为“更新选择”，不重复计数
- `closed` 后拒绝写入
- 匿名投票仅隐藏用户维度展示，不影响后台审计数据

---

## 5. SSE 事件模型

### 5.1 连接

- `GET /api/interact/sessions/{id}/stream`
- Headers: `Accept: text/event-stream`
- 需登录且 `student` 及以上

### 5.2 事件列表

| 事件 | 说明 |
|------|------|
| `session_updated` | 课堂状态变化 |
| `hand_raised` | 新举手 |
| `hand_cancelled` | 取消举手 |
| `hand_picked` | 指定发言 |
| `hand_dismissed` | 发言结束 |
| `timer_started` | 计时开始 |
| `timer_stopped` | 计时手动停止 |
| `timer_timeout` | 计时超时 |
| `vote_started` | 投票开始 |
| `vote_updated` | 投票过程更新 |
| `vote_result` | 投票结果 |
| `heartbeat` | 心跳 |

### 5.3 连接策略

- 服务端每 30 秒发送 `heartbeat`
- 客户端 60 秒未收到则自动重连
- SSE 断连不改变数据库状态，恢复后按 API 拉取当前状态快照

---

## 6. 课堂互动完整时序（摘要）

```text
1) teacher 创建课堂 pending
2) teacher 开始课堂 active
3) student 发起举手 -> queued
4) teacher 点名 -> speaking，并启动 timer
5) timer stop/timeout -> speaking 结束
6) teacher 发起 poll(open) -> student 投票 -> teacher 关闭(closed)
7) teacher 结束课堂 ended
```

---

## 7. 异常处理

| 场景 | 处理 |
|------|------|
| 非课堂创建者尝试改状态 | 返回 403 |
| ended 课堂仍投票/举手 | 返回 409 |
| 重复举手 | 返回 200 + 已在队列提示（幂等） |
| 关闭后继续投票 | 返回 409 |
| SSE 断开 | 客户端自动重连并拉取快照 |
