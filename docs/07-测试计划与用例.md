# 测试计划与用例（现行版）

## 1. 测试分层

| 层级 | 工具 | 目标 |
|------|------|------|
| API 冒烟 | `npm run smoke:all` | 快速验证核心业务链路与权限边界 |
| E2E（核心） | `npm run test:e2e:core` | 覆盖登录、主题切换、移动端菜单、阅读运行时加载 |
| E2E（专项） | `npm run test:e2e:auth` / `npm run test:e2e:realtime` | 认证建课链路、实时互动链路 |
| 线上回归 | `npm run test:e2e:prod` | 对生产环境做“只读式”页面级回归 |

说明：

1. 线上模式使用 `E2E_BASE_URL`，不会自动启动本地 `webServer`。
2. 线上默认串行执行，降低登录限流导致的假失败。

## 2. 核心链路用例

### TC-001 登录与权限跳转

| 步骤 | 预期 |
|------|------|
| 访问 `/login`，使用有效账号登录 | 登录成功，不停留在 `/login` |
| `registered` 访问受限页 | 重定向 `/invite` |
| `student` 访问 `/admin/*` | 前端拦截或后端返回 403 |

### TC-002 课堂创建链路

| 步骤 | 预期 |
|------|------|
| 教师登录后进入 `/interact` | 可见课堂列表与创建入口 |
| 创建课堂并确认 | 跳转 `/interact/{id}` |
| 学员登录 | 可进入互动主流程入口 |

### TC-003 主题系统（桌面 + 移动）

| 步骤 | 预期 |
|------|------|
| 桌面切换主题 | `data-theme` 与 `localStorage.theme` 同步变化 |
| 页面跳转后主题保持 | 跨页面不丢失 |
| 移动端打开汉堡菜单 | 背景滚动锁定，菜单可滚动 |
| 移动端菜单底部主题切换 | 可达、可点、可生效 |

### TC-004 阅读探究全书加载

| 步骤 | 预期 |
|------|------|
| 逐本打开 `/reading-legacy/book.html?book={id}` | 对应 `registry.json` 返回 200 |
| 运行时初始化 | Tab 渲染成功，无“页面初始化失败”提示 |

## 3. 发布前最小回归集

按顺序执行：

```bash
npm run build
npm run smoke:all
npm run test:e2e:core
npm run test:e2e:auth
```

生产回归（可选但推荐）：

```bash
npm run test:e2e:prod
```

## 4. 失败处理原则

1. 先区分“环境问题”与“产品回归”：例如账号限流、网络抖动、证书/网关问题。
2. E2E 失败时优先看 `test-results/**/error-context.md` 与 trace。
3. 若仅线上失败，本地通过：先复核线上部署版本与配置是否已更新到目标 commit。

