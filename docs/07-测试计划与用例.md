# 测试计划与用例

## 1. 测试策略

| 类型 | 工具 | 覆盖范围 |
|------|------|---------|
| 单元测试 | Vitest | 校验逻辑、权限判断、状态机转换 |
| API 测试 | Vitest + supertest | 认证、邀请码、互动、作业、讨论 |
| E2E 测试 | Playwright | 注册到学习到互动主流程 |
| 并发测试 | k6 / 脚本 | 30 人课堂互动一致性 |
| 部署测试 | Docker Compose | 容器部署与回滚可用性 |

---

## 2. 主流程用例

### TC-001 用户名注册 -> 邀请码 -> 学员访问

| 步骤 | 操作 | 预期结果 |
|------|------|---------|
| 1 | 访问 `/register` | 显示注册表单 |
| 2 | 注册并自动登录 | 跳转 `/invite` |
| 3 | 输入邀请码 `YIQIDU2026` | 提示升级成功，角色变为 `student` |
| 4 | 访问 `/rules`、`/reading` | 正常展示 |
| 5 | 访问 `/admin` | 被拦截到首页 |

### TC-002 课堂互动全流程

| 步骤 | 角色 | 操作 | 预期结果 |
|------|------|------|---------|
| 1 | 教师 | 创建课堂 | `status=pending` |
| 2 | 教师 | 开始课堂 | `status=active` |
| 3 | 学员A | 举手 | 队列新增 |
| 4 | 教师 | 点名发言 + 计时 | 全员看到计时 |
| 5 | 教师 | 发起投票 | 全员收到投票 |
| 6 | 学员A | 提交投票 | 计票成功 |
| 7 | 教师 | 关闭投票并结束课堂 | 公布结果，课堂 `ended` |

### TC-003 作业与反馈闭环

| 步骤 | 角色 | 操作 | 预期结果 |
|------|------|------|---------|
| 1 | 学员 | 提交作业 | 状态 `submitted` |
| 2 | 学员 | 提交反馈 | 反馈入库 |
| 3 | 教师 | 批阅作业 | 状态改为 `reviewed` |

### TC-004 留言讨论与治理

| 步骤 | 角色 | 操作 | 预期结果 |
|------|------|------|---------|
| 1 | 学员 | 在 `/discussion` 发帖 | 发布即显示 |
| 2 | 学员 | 评论帖子 | 评论显示 |
| 3 | 教师 | 隐藏评论 | 评论状态改为 `hidden` |
| 4 | 管理员 | 封禁违规用户 | 用户角色变为 `blocked`，治理日志落库 |

---

## 3. 权限越权用例

### TC-P01 未登录访问受限资源

| 路由/API | 预期 |
|----------|------|
| `/rules`、`/reading`、`/interact` | 跳转 `/login` |
| `/api/assignments` | 401 |
| `/api/discussion/posts` | 401 |

### TC-P02 registered 越权

| 路由/API | 预期 |
|----------|------|
| `/rules`、`/reading`、`/discussion` | 跳转 `/invite` |
| `/invite` | 正常可访问 |
| `/admin` | 跳首页 |

### TC-P03 student 越权

| 路由/API | 预期 |
|----------|------|
| `/admin/users` | 跳首页 |
| `/api/admin/invites` | 403 |
| `/api/interact/sessions`（创建课堂） | 403 |

### TC-P04 blocked 用户

| 场景 | 预期 |
|------|------|
| 访问受限页面 | 跳转 `/login?error=blocked` |
| 调用受限 API | 403 |

---

## 4. 防刷与幂等用例

| 用例 | 操作 | 预期 |
|------|------|------|
| TC-R01 登录防刷 | 同一 IP 连续 21 次错误登录 | 第 21 次返回 429 |
| TC-R02 邀请码防刷 | 同一用户第 11 次错误邀请码 | 返回 429 |
| TC-R03 重复举手 | 同一用户连续点击举手 | 只保留一条排队记录 |
| TC-R04 重复投票提交 | 同用户重复提交同一投票 | 覆盖更新，不重复计数 |

> 短信防刷用例在 MVP+1 执行（短信启用后补测）。

---

## 5. 并发一致性用例（30 人）

### TC-C01 30 人同时举手

- 预期：队列无重复、无丢失、顺序可追溯

### TC-C02 30 人同时投票

- 预期：最终票数准确等于有效投票人数

### TC-C03 邀请码并发核销

- 配置 `max_uses=10`，15 人同时核销
- 预期：10 人成功，5 人 `CODE_EXHAUSTED`，`used_count=10`

---

## 6. Docker 部署测试

| 用例 | 操作 | 预期 |
|------|------|------|
| TC-D01 首次启动 | `docker compose up -d --build` | 容器健康、站点可访问 |
| TC-D02 重启恢复 | `docker compose restart` | 服务恢复且数据不丢失 |
| TC-D03 数据持久化 | 重建容器后查询用户/作业数据 | 数据仍在 |
| TC-D04 回滚 | 使用旧镜像重新部署 | 业务可恢复 |

---

## 7. 回归最小集（每次发布前）

1. `npm run build` 成功
2. 用户名注册登录成功
3. 邀请码升级成功
4. student 访问受限页成功
5. student 访问管理页被拦截
6. 阅读站 `/reading` 可访问
7. 课堂创建 + 举手 + 投票可跑通
8. 作业提交成功
9. 留言发布与治理动作成功
10. Docker 健康检查通过
