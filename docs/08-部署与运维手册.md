# 部署与运维手册（现行版）

> 适用部署：Docker（本地与 ECS 一致）  
> 运行端口：容器内 `3000`，宿主机按需映射（常见 `8000:3000`）

## 1. 必备环境变量

| 变量名 | 必填 | 说明 |
|------|:---:|------|
| `NEXTAUTH_URL` | 是 | 外网完整地址（如 `https://tongxy.xyz`） |
| `NEXTAUTH_SECRET` | 是 | 会话签名密钥（建议 32+ 随机字符） |
| `DATABASE_URL` | 是 | SQLite 路径（建议 `file:/app/data/course.db`） |
| `ADMIN_USERNAME` | 是 | 初始化管理员账号 |
| `ADMIN_PASSWORD` | 是 | 初始化管理员密码 |
| `NODE_ENV` | 建议 | 固定 `production` |

参考模板：`.env.production.example`

## 2. 本地部署（Docker Compose）

1. 准备环境变量文件：

```bash
cp .env.production.example .env.production
```

2. 构建并启动：

```bash
docker compose up -d --build
```

3. 验证健康状态：

```bash
curl -fsS http://127.0.0.1:3000/api/health
docker compose ps
```

说明：

1. `docker-compose.yml` 使用命名卷持久化：
`yiqidu_data`、`yiqidu_uploads`、`yiqidu_logs`。
2. 线上建议通过 Nginx/SLB 反向代理到容器端口。

## 3. ECS 部署（建议流程）

1. 服务器拉取最新代码：

```bash
git pull --ff-only origin master
```

2. 构建镜像：

```bash
docker build -t yiqidu-learning-platform:latest .
```

3. 重启应用容器（示例映射 `8000:3000`）：

```bash
docker rm -f yiqidu-app || true
docker run -d \
  --name yiqidu-app \
  --restart unless-stopped \
  -p 8000:3000 \
  --env-file /root/yiqidu.env \
  -v yiqidu_data:/app/data \
  -v yiqidu_uploads:/app/uploads \
  -v yiqidu_logs:/app/logs \
  yiqidu-learning-platform:latest
```

4. 检查服务：

```bash
docker ps --filter name=yiqidu-app
docker logs --tail 100 yiqidu-app
curl -fsS http://127.0.0.1:8000/api/health
```

## 4. 升级与回滚

### 4.1 升级

```bash
git pull --ff-only origin master
docker build -t yiqidu-learning-platform:latest .
# 重启容器（同上）
```

### 4.2 回滚

```bash
git checkout <last-good-commit>
docker build -t yiqidu-learning-platform:rollback .
# 用 rollback 镜像重启容器
```

数据卷不回滚，若涉及结构变更请先备份数据库。

## 5. 备份与恢复

备份：

```bash
npm run backup:create
```

恢复：

```bash
npm run backup:restore -- data/backups/<backup-file>.db
```

## 6. 常见问题

### 6.1 容器重启失败

排查顺序：

1. `docker logs yiqidu-app`
2. 检查 `.env` 必填变量是否缺失
3. 检查数据卷权限与磁盘空间

### 6.2 SSE 更新异常

若通过 Nginx 转发，确认：

1. `proxy_buffering off`
2. `proxy_read_timeout` 足够长
3. `/api/interact/*/stream` 不走 CDN 缓存

### 6.3 SQLite 锁冲突

SQLite 建议单写实例。若需要多实例并发写，需迁移到服务型数据库。

## 7. 相关文档

- `DEPLOY.md`（Docker 打包与 ECS 部署准备）
- `docs/13-前后端联调与API冒烟手册.md`（联调与回归执行）

