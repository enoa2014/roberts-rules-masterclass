# 部署与运维手册

> 推荐部署方式：Docker Compose（首选）
> 备选：PM2 + Nginx（仅在不使用 Docker 时）

## 1. 环境变量清单

| 变量名 | 必填 | 说明 |
|--------|:----:|------|
| `NEXTAUTH_URL` | ✅ | 站点完整 URL（HTTPS） |
| `NEXTAUTH_SECRET` | ✅ | JWT 签名密钥（32+ 字符） |
| `DATABASE_URL` | ✅ | SQLite 路径（容器内示例：`file:/app/data/course.db`） |
| `ADMIN_USERNAME` | ✅ | 初始管理员用户名 |
| `ADMIN_PASSWORD` | ✅ | 初始管理员密码 |
| `NODE_ENV` | ✅ | `production` |
| `PORT` | - | 默认 `3000` |
| `ALI_SMS_*` | ⚠️ | 短信增强功能（MVP+1） |

`.env.production` 示例：

```bash
NEXTAUTH_URL=https://yiqidu.example.com
NEXTAUTH_SECRET=<replace_me>
DATABASE_URL=file:/app/data/course.db
ADMIN_USERNAME=admin
ADMIN_PASSWORD=<replace_me>
NODE_ENV=production
PORT=3000

# MVP+1 可选
ALI_SMS_ACCESS_KEY=
ALI_SMS_ACCESS_SECRET=
ALI_SMS_SIGN_NAME=
ALI_SMS_TEMPLATE_CODE=
```

---

## 2. Docker 部署（推荐）

### 2.1 Dockerfile（示例）

```dockerfile
FROM node:22-alpine AS deps
WORKDIR /app
COPY package*.json ./
RUN npm ci

FROM node:22-alpine AS builder
WORKDIR /app
COPY --from=deps /app/node_modules ./node_modules
COPY . .
RUN npm run build

FROM node:22-alpine AS runner
WORKDIR /app
ENV NODE_ENV=production
COPY --from=builder /app .
RUN mkdir -p /app/data /app/logs
EXPOSE 3000
CMD ["npm", "start"]
```

### 2.2 docker-compose.yml（示例）

```yaml
services:
  app:
    build: .
    container_name: yiqidu-app
    restart: unless-stopped
    env_file:
      - .env.production
    ports:
      - "3000:3000"
    volumes:
      - ./data:/app/data
      - ./logs:/app/logs
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://127.0.0.1:3000/api/health || exit 1"]
      interval: 30s
      timeout: 5s
      retries: 5
```

### 2.3 首次部署步骤

```bash
cd /home/ctyun/work/tttt
mkdir -p data logs
cp .env.production.example .env.production
# 编辑 .env.production

# 构建并启动
docker compose up -d --build

# 初始化数据库（若应用未自动执行）
docker compose exec app npx drizzle-kit push

# 创建管理员（若有脚本）
docker compose exec app node scripts/init-admin.js

# 查看状态
docker compose ps
docker compose logs -f app
```

### 2.4 更新部署

```bash
cd /home/ctyun/work/tttt
git pull

docker compose build --no-cache app
docker compose up -d app

docker compose exec app npx drizzle-kit push
docker compose logs --tail=100 app
```

### 2.5 回滚建议

```bash
# 回退代码
cd /home/ctyun/work/tttt
git checkout <last-good-commit>

# 重新构建并启动
docker compose build app
docker compose up -d app
```

> 若含不可逆数据库变更，先恢复 `data/backups/*.db` 再回滚应用版本。

---

## 3. Nginx 反向代理（Docker 场景）

```nginx
server {
    listen 443 ssl http2;
    server_name yiqidu.example.com;

    ssl_certificate     /path/to/cert.pem;
    ssl_certificate_key /path/to/key.pem;

    # 仅信任你的 CDN/反代出口网段，不要使用 0.0.0.0/0
    # set_real_ip_from 203.0.113.0/24;
    # set_real_ip_from 198.51.100.0/24;
    real_ip_header X-Forwarded-For;
    real_ip_recursive on;

    location / {
        proxy_pass http://127.0.0.1:3000;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # SSE 必需
        proxy_buffering off;
        proxy_cache off;
        proxy_read_timeout 86400s;
    }

    location /_next/static/ {
        proxy_pass http://127.0.0.1:3000;
        expires 365d;
        add_header Cache-Control "public, immutable";
    }
}

server {
    listen 80;
    server_name yiqidu.example.com;
    return 301 https://$host$request_uri;
}
```

---

## 4. CDN 配置（EdgeOne/ESA 可选）

1. 域名 CNAME 到 CDN
2. 回源指向 ECS（443）
3. 缓存建议：
- `/_next/static/*`：365 天
- `/reading-legacy/assets/*`：30 天
- `/api/*`：不缓存
4. 开启 WAF/DDoS 防护
5. 确认客户端真实 IP 透传

---

## 5. 备份与恢复（Docker）

### 5.1 自动备份

仓库已提供可执行脚本：`scripts/backup.sh`

```bash
# 手动执行一次备份
npm run backup:create
```

```bash
# crontab
0 3 * * * cd /home/ctyun/work/tttt && bash scripts/backup.sh >> /home/ctyun/work/tttt/logs/backup.log 2>&1
```

### 5.2 恢复

```bash
docker compose stop app
bash scripts/restore.sh data/backups/course_YYYYMMDD_HHMMSS.db
docker compose start app
```

---

## 6. 常见故障

### 6.1 容器反复重启

```bash
docker compose logs --tail=200 app
# 常见原因：环境变量缺失、数据库目录权限错误、迁移失败
```

### 6.2 SQLite 锁冲突

```bash
# 确保仅一个 app 实例写同一个 sqlite 文件
docker compose ps
# 如需并发扩容，先迁移到 MySQL/PostgreSQL
```

### 6.3 SSE 经常断开

- 检查 Nginx `proxy_buffering off` 与 `proxy_read_timeout`
- 检查 CDN 是否对 `/api/interact/*/stream` 施加超时

---

## 7. 备选：PM2 部署（非 Docker）

如果暂时不使用 Docker，可按 Node + PM2 方式部署。建议仅用于临时环境，生产优先 Docker 以降低环境漂移。

---

## 8. 安全清单

- [ ] `NEXTAUTH_SECRET` 为随机强密钥
- [ ] `.env.production` 权限为 `600`
- [ ] 防火墙仅开放 80/443
- [ ] 强制 HTTPS
- [ ] 可信代理网段已正确配置
- [ ] 定期验证备份可恢复
