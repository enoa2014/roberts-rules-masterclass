# 数据库设计与迁移策略

## 1. 技术选型

- 数据库：SQLite 3（`better-sqlite3`）
- ORM：Drizzle ORM
- 数据库文件：`data/course.db`
- 迁移工具：`drizzle-kit`
- 一致性策略：单实例写入 + 关键操作事务化（邀请码核销、投票写入、角色变更）

---

## 2. 表结构（首发）

### 2.1 users

```sql
CREATE TABLE users (
  id          INTEGER PRIMARY KEY AUTOINCREMENT,
  phone       TEXT UNIQUE,
  username    TEXT UNIQUE,
  password    TEXT,
  nickname    TEXT,
  role        TEXT NOT NULL DEFAULT 'registered'
              CHECK(role IN ('registered', 'student', 'teacher', 'admin', 'blocked')),
  created_at  TEXT NOT NULL DEFAULT (datetime('now')),
  updated_at  TEXT NOT NULL DEFAULT (datetime('now')),
  CHECK (phone IS NOT NULL OR username IS NOT NULL),
  CHECK (username IS NULL OR password IS NOT NULL)
);

CREATE INDEX idx_users_role ON users(role);
```

### 2.2 invite_codes

```sql
CREATE TABLE invite_codes (
  id          INTEGER PRIMARY KEY AUTOINCREMENT,
  code        TEXT NOT NULL UNIQUE,
  max_uses    INTEGER NOT NULL DEFAULT 0, -- 0=无限
  used_count  INTEGER NOT NULL DEFAULT 0,
  expires_at  TEXT,
  created_by  INTEGER REFERENCES users(id),
  created_at  TEXT NOT NULL DEFAULT (datetime('now')),
  CHECK (max_uses >= 0),
  CHECK (used_count >= 0)
);
```

### 2.3 invite_code_uses

```sql
CREATE TABLE invite_code_uses (
  id          INTEGER PRIMARY KEY AUTOINCREMENT,
  code_id     INTEGER NOT NULL REFERENCES invite_codes(id),
  user_id     INTEGER NOT NULL REFERENCES users(id),
  used_at     TEXT NOT NULL DEFAULT (datetime('now')),
  UNIQUE(code_id, user_id)
);

CREATE INDEX idx_invite_code_uses_user ON invite_code_uses(user_id);
```

### 2.4 class_sessions

```sql
CREATE TABLE class_sessions (
  id          INTEGER PRIMARY KEY AUTOINCREMENT,
  title       TEXT NOT NULL,
  status      TEXT NOT NULL DEFAULT 'pending'
              CHECK(status IN ('pending', 'active', 'ended')),
  created_by  INTEGER NOT NULL REFERENCES users(id),
  created_at  TEXT NOT NULL DEFAULT (datetime('now')),
  ended_at    TEXT
);

CREATE INDEX idx_class_sessions_status ON class_sessions(status);
```

### 2.5 hand_raises

```sql
CREATE TABLE hand_raises (
  id               INTEGER PRIMARY KEY AUTOINCREMENT,
  class_session_id INTEGER NOT NULL REFERENCES class_sessions(id),
  user_id          INTEGER NOT NULL REFERENCES users(id),
  status           TEXT NOT NULL DEFAULT 'queued'
                   CHECK(status IN ('queued', 'speaking', 'done', 'cancelled')),
  raised_at        TEXT NOT NULL DEFAULT (datetime('now')),
  speaking_at      TEXT,
  ended_at         TEXT
);

CREATE INDEX idx_hand_raises_session_status ON hand_raises(class_session_id, status);
CREATE UNIQUE INDEX idx_hand_raises_unique_open
  ON hand_raises(class_session_id, user_id)
  WHERE status IN ('queued', 'speaking');
```

### 2.6 speech_timers

```sql
CREATE TABLE speech_timers (
  id               INTEGER PRIMARY KEY AUTOINCREMENT,
  class_session_id INTEGER NOT NULL REFERENCES class_sessions(id),
  user_id          INTEGER NOT NULL REFERENCES users(id),
  duration_sec     INTEGER NOT NULL,
  started_at       TEXT NOT NULL,
  ended_at         TEXT,
  CHECK (duration_sec > 0)
);

CREATE INDEX idx_speech_timers_session ON speech_timers(class_session_id);
```

### 2.7 polls

```sql
CREATE TABLE polls (
  id               INTEGER PRIMARY KEY AUTOINCREMENT,
  class_session_id INTEGER NOT NULL REFERENCES class_sessions(id),
  question         TEXT NOT NULL,
  type             TEXT NOT NULL CHECK(type IN ('single', 'multiple')),
  anonymous        INTEGER NOT NULL DEFAULT 0,
  status           TEXT NOT NULL DEFAULT 'open' CHECK(status IN ('open', 'closed')),
  created_by       INTEGER NOT NULL REFERENCES users(id),
  created_at       TEXT NOT NULL DEFAULT (datetime('now'))
);

CREATE INDEX idx_polls_session_status ON polls(class_session_id, status);
```

### 2.8 poll_options

```sql
CREATE TABLE poll_options (
  id          INTEGER PRIMARY KEY AUTOINCREMENT,
  poll_id     INTEGER NOT NULL REFERENCES polls(id),
  label       TEXT NOT NULL,
  ord         INTEGER NOT NULL,
  UNIQUE(poll_id, ord)
);
```

### 2.9 poll_votes

```sql
CREATE TABLE poll_votes (
  id          INTEGER PRIMARY KEY AUTOINCREMENT,
  poll_id     INTEGER NOT NULL REFERENCES polls(id),
  option_id   INTEGER NOT NULL REFERENCES poll_options(id),
  user_id     INTEGER NOT NULL REFERENCES users(id),
  created_at  TEXT NOT NULL DEFAULT (datetime('now')),
  UNIQUE(poll_id, option_id, user_id)
);

CREATE INDEX idx_poll_votes_poll ON poll_votes(poll_id);
CREATE INDEX idx_poll_votes_user ON poll_votes(user_id);
```

### 2.10 assignments

```sql
CREATE TABLE assignments (
  id          INTEGER PRIMARY KEY AUTOINCREMENT,
  user_id     INTEGER NOT NULL REFERENCES users(id),
  lesson_id   TEXT NOT NULL,
  content     TEXT,
  file_path   TEXT,
  status      TEXT NOT NULL DEFAULT 'submitted'
              CHECK(status IN ('submitted', 'reviewed')),
  reviewed_by INTEGER REFERENCES users(id),
  created_at  TEXT NOT NULL DEFAULT (datetime('now')),
  updated_at  TEXT NOT NULL DEFAULT (datetime('now'))
);

CREATE INDEX idx_assignments_user ON assignments(user_id);
CREATE INDEX idx_assignments_status ON assignments(status);
```

### 2.11 feedbacks

```sql
CREATE TABLE feedbacks (
  id               INTEGER PRIMARY KEY AUTOINCREMENT,
  user_id          INTEGER NOT NULL REFERENCES users(id),
  class_session_id INTEGER REFERENCES class_sessions(id),
  rating           INTEGER CHECK(rating BETWEEN 1 AND 5),
  content          TEXT,
  created_at       TEXT NOT NULL DEFAULT (datetime('now'))
);

CREATE INDEX idx_feedbacks_session ON feedbacks(class_session_id);
```

### 2.12 discussion_posts / discussion_comments / moderation_logs

```sql
CREATE TABLE discussion_posts (
  id          INTEGER PRIMARY KEY AUTOINCREMENT,
  user_id     INTEGER NOT NULL REFERENCES users(id),
  title       TEXT,
  content     TEXT NOT NULL,
  status      TEXT NOT NULL DEFAULT 'visible'
              CHECK(status IN ('visible', 'hidden', 'deleted')),
  created_at  TEXT NOT NULL DEFAULT (datetime('now'))
);

CREATE TABLE discussion_comments (
  id          INTEGER PRIMARY KEY AUTOINCREMENT,
  post_id     INTEGER NOT NULL REFERENCES discussion_posts(id),
  user_id     INTEGER NOT NULL REFERENCES users(id),
  content     TEXT NOT NULL,
  status      TEXT NOT NULL DEFAULT 'visible'
              CHECK(status IN ('visible', 'hidden', 'deleted')),
  created_at  TEXT NOT NULL DEFAULT (datetime('now'))
);

CREATE TABLE moderation_logs (
  id          INTEGER PRIMARY KEY AUTOINCREMENT,
  operator_id INTEGER NOT NULL REFERENCES users(id),
  target_type TEXT NOT NULL CHECK(target_type IN ('post', 'comment', 'user')),
  target_id   INTEGER NOT NULL,
  action      TEXT NOT NULL CHECK(action IN ('hide', 'delete', 'block', 'unblock')),
  reason      TEXT,
  created_at  TEXT NOT NULL DEFAULT (datetime('now'))
);

CREATE INDEX idx_discussion_posts_status ON discussion_posts(status);
CREATE INDEX idx_discussion_comments_post ON discussion_comments(post_id);
CREATE INDEX idx_moderation_logs_target ON moderation_logs(target_type, target_id);
```

### 2.13 短信相关（MVP+1）

```sql
CREATE TABLE sms_codes (
  id          INTEGER PRIMARY KEY AUTOINCREMENT,
  phone       TEXT NOT NULL,
  code        TEXT NOT NULL,
  expires_at  TEXT NOT NULL,
  used        INTEGER NOT NULL DEFAULT 0,
  created_at  TEXT NOT NULL DEFAULT (datetime('now'))
);

CREATE INDEX idx_sms_codes_phone ON sms_codes(phone);
```

---

## 3. 关键事务与并发一致性

### 3.1 邀请码核销（必须事务）

```sql
BEGIN IMMEDIATE;

-- 1. 读取邀请码（应用层校验是否存在）
SELECT id, max_uses, used_count, expires_at FROM invite_codes WHERE code = ?;

-- 2. 检查是否已被该用户使用（命中则直接回滚并返回）
SELECT id FROM invite_code_uses WHERE code_id = ? AND user_id = ?;

-- 3. 条件更新，防止并发超发
UPDATE invite_codes
SET used_count = used_count + 1
WHERE id = ?
  AND (max_uses = 0 OR used_count < max_uses)
  AND (expires_at IS NULL OR expires_at > datetime('now'));

-- 4. 校验更新是否成功（应用层判断 changes() == 1；否则回滚并返回超限/过期）
SELECT changes();

-- 5. 写使用记录（唯一约束保护重复核销）
INSERT INTO invite_code_uses (code_id, user_id) VALUES (?, ?);

-- 6. 更新角色
UPDATE users SET role = 'student', updated_at = datetime('now') WHERE id = ?;

COMMIT;
```

### 3.2 投票提交（幂等）

- 单选：先删除该用户在该投票下旧记录，再写入一条新记录（同事务）
- 多选：按选项集合覆盖写入（先删后插，同事务）
- 投票关闭后禁止写入

### 3.3 举手幂等

- 利用 `idx_hand_raises_unique_open`，同一课堂同一用户不能重复处于 `queued/speaking`

---

## 4. 迁移策略

### 4.1 原则

- 每次改动都通过 Drizzle migration 落盘
- 避免“直接改线上库”
- 采用 Expand -> Migrate -> Contract 方式演进

### 4.2 命令

```bash
# 生成迁移
npx drizzle-kit generate

# 应用迁移
npx drizzle-kit push

# 查看数据库
npx drizzle-kit studio
```

---

## 5. 备份与恢复

### 5.1 每日自动备份

```bash
#!/bin/bash
set -e
TIMESTAMP=$(date +%Y%m%d_%H%M%S)
DB_PATH="/home/ctyun/work/tttt/data/course.db"
BACKUP_DIR="/home/ctyun/work/tttt/data/backups"
mkdir -p "$BACKUP_DIR"
sqlite3 "$DB_PATH" ".backup '$BACKUP_DIR/course_$TIMESTAMP.db'"
find "$BACKUP_DIR" -name "course_*.db" -mtime +30 -delete
```

crontab:

```bash
0 3 * * * /home/ctyun/work/tttt/scripts/backup.sh >> /home/ctyun/work/tttt/logs/backup.log 2>&1
```

### 5.2 恢复步骤

```bash
# 停服务（Docker 部署示例）
docker compose stop app

# 备份当前库
cp data/course.db data/course_before_restore_$(date +%Y%m%d_%H%M%S).db

# 覆盖恢复
cp data/backups/course_YYYYMMDD_HHMMSS.db data/course.db

# 启服务
docker compose start app
```

---

## 6. 初始化数据

```sql
INSERT INTO users (username, password, nickname, role)
VALUES ('admin', '$2b$10$<bcrypt-hash>', '管理员', 'admin');

INSERT INTO invite_codes (code, max_uses, created_by)
VALUES ('YIQIDU2026', 0, 1);
```

> 生产环境不要使用固定初始密码，部署时动态生成并立即修改。
