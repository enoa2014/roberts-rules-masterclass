# 阅读站嵌入与重构路线图

## 1. 目标与原则

- 首发目标：最短路径接入统一登录与权限控制
- 策略：先整体嵌入，再分批重构
- 原则：先可用、再优化；不在首发阶段重写全部阅读页

---

## 2. 现有资产

- 源项目：`/home/ctyun/work/read/reading-garden`
- 形态：静态站（HTML/CSS/JS + JSON 数据）
- 当前特点：无后端、依赖前端渲染、可独立运行

---

## 3. 第一阶段：整体嵌入（MVP 首发）

### 3.1 目录规划

```text
public/reading-legacy/
├── index.html
├── books/
├── css/
├── js/
├── data/
└── assets/

app/reading/
├── page.tsx
└── [bookSlug]/page.tsx
```

### 3.2 实施步骤

1. 将阅读站静态产物整体复制到 `public/reading-legacy/`
2. 在 `app/reading/page.tsx` 使用 iframe 挂载 `public/reading-legacy/index.html`
3. 通过统一 `middleware` 保护 `/reading/*`
4. 下线原独立入口，避免绕过权限

### 3.3 推荐嵌入方式

```tsx
export default function ReadingPage() {
  return (
    <iframe
      src="/reading-legacy/index.html"
      title="阅读探究"
      style={{ width: '100%', height: 'calc(100vh - 72px)', border: 'none' }}
    />
  );
}
```

说明：首发优先使用 iframe 隔离样式与脚本，减少主站冲突风险。

### 3.4 兼容风险与处理

| 风险 | 处理 |
|------|------|
| CSS 冲突 | iframe 隔离，避免全局样式污染 |
| JS 全局变量冲突 | iframe 隔离 |
| 资源路径失效 | 批量改为 `/reading-legacy/...` 绝对路径 |
| 权限绕过 | 保证仅通过 `/reading/*` 入口访问并受鉴权控制 |

### 3.5 首发验收

- 未登录访问 `/reading` 跳转 `/login`
- `registered` 访问 `/reading` 跳转 `/invite`
- `student+` 可正常浏览书架和书目详情
- 关键页面在手机微信内可用

---

## 4. 第二阶段：逐步重构（MVP 后）

### 4.1 批次规划

1. 批次 1：重构书架首页（`/reading`）
2. 批次 2：按书目逐本重构（先 `totto-chan`）
3. 批次 3：补后端能力（阅读笔记/批注/进度）

### 4.2 重构路径

- 数据层：继续复用现有 `data/*.json`，先不改数据格式
- 视图层：逐步替换为 Next.js 组件 + CSS Modules
- 能力层：重构完成后再接后端 API

### 4.3 上线策略

- 支持“新旧并行”：重构完成的页面走新路由，未重构页面仍走 legacy
- 每个批次独立上线，减少风险

---

## 5. 退出 legacy 的条件

满足以下条件后可移除 `public/reading-legacy/`：

1. 所有目标书目页面完成 Next.js 化
2. 关键互动模块（人物关系、主题探究、测验）已迁移
3. 历史访问数据与 SEO 校验通过
4. 回归测试通过并完成灰度观察
