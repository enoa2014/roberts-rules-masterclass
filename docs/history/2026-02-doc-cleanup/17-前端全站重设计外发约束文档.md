# 前端全站重设计外发约束文档（外发版）

> 用途：将本文件外发给任意 AI 产品（ChatGPT/Gemini/Claude/Opus 等），约束其在**不接触本仓库写权限**的情况下，输出可接入、可运行、可验收的前端重设计交付。
>
> 核心原则：**功能冻结，视觉与前端实现可重构**。

---

## 0. 使用方式

1. 对外发包时：优先使用本文第 7.2 节“完整版提示词”。
2. 对外交付回收后：使用 `docs/18-前端重设计外发严格评审模板.md` 严格验收。
3. 若外部 AI 输出与本文任一“冻结约束”冲突，直接判定不合格并返工。

---

## 1. 目标与边界

### 1.1 本次目标

在不改变业务语义的前提下，完成全站前端重设计：

1. 重构视觉语言（配色、字体、间距、阴影、动效）。
2. 重构页面编排（信息层级、模块顺序、布局密度）。
3. 重构组件体系（导航、卡片、表单、列表、状态反馈）。
4. 保证现有用户流程可用、业务结果一致。
5. 形成可持续扩展的设计系统（token/语义层/组件层）。

### 1.2 非目标（本次不做）

1. 不新增后端业务能力（支付、消息系统、新鉴权协议等）。
2. 不改数据库结构。
3. 不改 API 路径与语义。
4. 不改角色权限规则。
5. 不做与业务无关的展示页炫技。

---

## 2. 当前工程基线（必须先理解）

### 2.1 Route Group 结构（冻结）

```text
app/
  (main)/          # 主站布局（SiteNav + SiteFooter + Providers）
    api/           # 全部 Route Handler API
    ...pages
  (independent)/   # 独立布局（不带主站 Nav/Footer）
    read/page.tsx  # 兼容入口，重定向到 /reading
```

1. 外发交付不得假设扁平 `app/*` 结构。
2. 新增/重构页面必须明确归属 `(main)` 或 `(independent)`。
3. API 路由语义保持 `app/(main)/api/*`，不可改为新前缀体系。

### 2.2 关键依赖版本（对齐现网）

| 依赖 | 版本 |
|---|---|
| Next.js | 16.1.6 |
| React | 19.2.3 |
| next-auth | 4.24.13 |
| drizzle-orm | 0.45.1 |
| better-sqlite3 | 12.6.2 |
| zod | 4.3.6 |
| Tailwind CSS | 4.1.18 |
| lucide-react | 0.564.0 |

> 说明：如使用 Tailwind，必须按 **Tailwind v4** 语法和构建方式交付，不能按 v3 默认写法。

### 2.3 认证与鉴权机制（冻结）

1. 认证方式：next-auth Credentials（用户名 + 密码）。
2. Session 策略：JWT。
3. 会话读取：
- 客户端：`useSession()`（`SessionProvider` 提供上下文）
- 服务端/API：`getServerSession(authOptions)`
- 路由守卫：`getToken()`
4. 最低会话字段：
- `session.user.id`
- `session.user.role`
- `token.role`

### 2.4 路由守卫机制（proxy）

1. 当前项目使用 `proxy.ts`（Next.js 16 机制），不是 `middleware.ts`。
2. `proxy.ts` 由 Next.js 按约定文件名自动挂载生效（无需手动 import）。
3. 外发交付不得替换重定向语义。
4. 必须保留静态资源保护前缀：`/reading-legacy`。
5. 保护逻辑要点：
- `_next`、`favicon.ico`、`/api/*` 放行；
- `/reading-legacy/*` 受鉴权控制；
- 未登录访问受限页跳 `/login?callbackUrl=...`。

### 2.5 阅读路由现状（冻结）

1. 主入口：`/reading`（主站布局）。
2. 兼容入口：`/read`（重定向到 `/reading`）。
3. 书籍阅读页左上角“返回”必须回 `/reading`。

---

## 3. 不可破坏合同

### 3.1 路由范围（最低覆盖）

| 模块 | 路由 |
|---|---|
| 公共与认证 | `/`, `/course`, `/about`, `/faq`, `/login`, `/register` |
| 过渡与学习 | `/invite`, `/profile`, `/reading`, `/rules`, `/tools`, `/resources` |
| 互动与课后 | `/interact`, `/interact/[sessionId]`, `/homework`, `/discussion` |
| 后台管理 | `/admin`, `/admin/users`, `/admin/invites`, `/admin/assignments`, `/admin/feedbacks`, `/admin/moderation`, `/admin/settings` |

### 3.2 路由-角色权限矩阵（冻结）

`✅` 可访问 | `→login` 跳登录 | `→invite` 跳邀请码页 | `→home` 跳首页 | `🚫` 拒绝

| 路由 | visitor | registered | student | teacher | admin | blocked |
|---|:---:|:---:|:---:|:---:|:---:|:---:|
| `/` | ✅ | ✅ | ✅ | ✅ | ✅ | ✅ |
| `/course` | ✅ | ✅ | ✅ | ✅ | ✅ | ✅ |
| `/about` | ✅ | ✅ | ✅ | ✅ | ✅ | ✅ |
| `/faq` | ✅ | ✅ | ✅ | ✅ | ✅ | ✅ |
| `/login` | ✅ | →home | →home | →home | →home | ✅ |
| `/register` | ✅ | →home | →home | →home | →home | ✅ |
| `/invite` | →login | ✅ | →home | →home | →home | 🚫 |
| `/profile` | →login | ✅ | ✅ | ✅ | ✅ | 🚫 |
| `/rules/*` | →login | →invite | ✅ | ✅ | ✅ | 🚫 |
| `/reading/*` | →login | →invite | ✅ | ✅ | ✅ | 🚫 |
| `/tools/*` | →login | →invite | ✅ | ✅ | ✅ | 🚫 |
| `/interact/*` | →login | →invite | ✅ | ✅ | ✅ | 🚫 |
| `/homework/*` | →login | →invite | ✅ | ✅ | ✅ | 🚫 |
| `/resources/*` | →login | →invite | ✅ | ✅ | ✅ | 🚫 |
| `/discussion/*` | →login | →invite | ✅ | ✅ | ✅ | 🚫 |
| `/admin` | →login | →home | →home | ✅ | ✅ | 🚫 |
| `/admin/users` | →login | →home | →home | →home | ✅ | 🚫 |
| `/admin/invites` | →login | →home | →home | →home | ✅ | 🚫 |
| `/admin/assignments` | →login | →home | →home | ✅ | ✅ | 🚫 |
| `/admin/feedbacks` | →login | →home | →home | ✅ | ✅ | 🚫 |
| `/admin/moderation` | →login | →home | →home | ✅ | ✅ | 🚫 |
| `/admin/settings` | →login | →home | →home | ✅ | ✅ | 🚫 |

### 3.3 重定向状态机（冻结）

1. 公开路由直接放行。
2. 未登录访问受限页：`→ /login?callbackUrl=...`。
3. `blocked`：仅可访问公开页与登录注册，其余 `→ /login?error=blocked`。
4. 非 blocked 已登录访问 `/login` 或 `/register`：`→ /`。
5. `/invite` 仅 `registered` 可访问；`/profile` 允许已登录非封禁角色。
6. `/admin/users`、`/admin/invites` 仅 `admin`。
7. 其他 `/admin/*` 仅 `teacher/admin`。
8. `registered` 访问学员区：统一 `→ /invite`。

### 3.4 角色能力边界（前端不可越权）

| 能力 | student | teacher | admin |
|---|---|---|---|
| 创建课堂 `/api/interact/sessions` | ❌ | ✅ | ✅ |
| 课堂状态切换 `/status` | ❌ | ✅ | ✅ |
| 踢人/全员禁言 `/kick` `/mute` | ❌ | ✅ | ✅ |
| 作业批阅 `/assignments/[id]/review` | ❌ | ✅ | ✅ |
| 用户角色管理 `/admin/users` | ❌ | ❌ | ✅ |
| 邀请码管理 `/admin/invites` | ❌ | ❌ | ✅ |
| 系统设置 `/admin/settings` | ❌ | ❌（路由可见，接口不允许） | ✅ |

> 说明：`/admin/settings` 当前语义是“teacher 路由可见但接口 403”，外发交付需保持该行为，不得前端绕过接口权限。

---

## 4. 页面-接口-展示合同（可执行版）

### 4.1 全路由页面展示基线（先看这个）

> 本节用于约束“前台必须出现什么”，即使某些页面没有强依赖后端 API，也不能缺功能位。

| 页面 | 数据来源 | 前台必须展示 | 备注 |
|---|---|---|---|
| `/` | 静态/配置 | Hero 价值主张、核心入口导航（课程/阅读/互动/工具/资源）、角色相关入口 | 不可变成纯展示落地页 |
| `/course` | 静态或内容数据 | 课程总览、阶段/主题信息、进入学习入口 | 与学习区形成闭环跳转 |
| `/about` | 静态 | 平台说明、适用人群、参与方式 | 不可空白页 |
| `/faq` | 静态 | 常见问题分组、答案折叠或列表 | 至少覆盖注册/邀请码/互动/作业 |
| `/login` | next-auth | 用户名/密码、失败提示、跳转回调处理 | 错误态不可吞掉 |
| `/register` | `/api/settings` + `/api/auth/register` | 注册开关、公告、字段校验、成功反馈 | 注册关闭时需明确提示 |
| `/invite` | `/api/invite/verify` | 邀请码输入、失败提示、成功后升级反馈 | 仅 registered 可见 |
| `/profile` | session | 用户基础信息（用户名/昵称/角色）、会话状态提示 | 不得暴露敏感字段 |
| `/rules` | 静态/内容数据 | 规则列表、规则详情入口 | 仅 student+ 可进 |
| `/tools` | 静态/内容数据 | 工具列表、工具详情入口 | 仅 student+ 可进 |
| `/resources` | 静态/内容数据 | 资源清单、基础筛选/分组展示 | 仅 student+ 可进 |
| `/reading` | 静态 + `/reading-legacy` 资源 | 书籍列表、封面、进入阅读按钮 | 阅读按钮目标是 `/reading-legacy/book.html?book=...` |
| `/read` | 路由逻辑 | 兼容跳转到 `/reading` | 必须 301/302 重定向，不保留旧入口 UI |
| `/interact` | `/api/interact/sessions` | 课堂列表、状态、创建入口（教师/管理员） | 学员仅见可参与入口 |
| `/interact/[sessionId]` | SSE + 互动 API | 会话状态、队列、发言计时、投票、角色差异控件 | 见 4.3 节冻结字段 |
| `/homework` | `/api/assignments*` | 作业列表、提交入口、状态、附件下载 | teacher/admin 可批阅 |
| `/discussion` | `/api/discussion/*` | 帖子流、评论区、发帖回帖 | 作者昵称与评论数必须显示 |
| `/admin` | 聚合页 | 管理模块导航、权限可达提示 | 仅 teacher/admin |
| `/admin/users` | `/api/admin/users*` | 用户列表、角色筛选、角色变更 | 仅 admin |
| `/admin/invites` | `/api/admin/invites*` | 邀请码列表、创建、作废、使用情况 | 仅 admin |
| `/admin/assignments` | `/api/assignments?all=true` + review API | 批阅列表、筛选、状态流转 | teacher/admin |
| `/admin/feedbacks` | `/api/feedbacks` | 反馈列表、筛选、导出 | teacher/admin |
| `/admin/moderation` | `/api/admin/moderation/*` | 治理动作入口、治理日志 | teacher/admin |
| `/admin/settings` | `/api/admin/settings` | 设置项展示、保存反馈或无权限提示 | teacher 路由可见但接口 403 |

### 4.2 认证与过渡（API 合同）

| 页面 | 接口 | 方法 | 请求关键字段 | 响应关键字段 | 前台必须展示 |
|---|---|---|---|---|---|
| `/login` | `/api/auth/[...nextauth]` | POST | `username`, `password` | next-auth 认证结果 | 用户名、密码、登录失败提示 |
| `/register` | `/api/settings` | GET | 无 | `settings.registrationEnabled`, `settings.siteAnnouncement` | 注册开关状态、公告 |
| `/register` | `/api/auth/register` | POST | `username`, `password`, `nickname?` | `user.id`, `user.username`, `user.role` | 注册表单、字段校验、失败原因 |
| `/invite` | `/api/invite/verify` | POST | `code` | `success`, `newRole`, `message` | 邀请码输入、失败提示、成功提示 |

### 4.3 课堂互动（含 SSE）

| 页面 | 接口 | 方法 | 请求关键字段 | 响应关键字段 | 前台必须展示 |
|---|---|---|---|---|---|
| `/interact` | `/api/interact/sessions` | GET | `status?` | `sessions[].id,title,status,createdAt` | 课堂列表（标题、状态、时间） |
| `/interact` | `/api/interact/sessions` | POST | `title` | 课堂对象（含 `id`） | 创建课堂入口、失败提示 |
| `/interact/[sessionId]` | `/api/interact/sessions/[id]/stream` | GET(SSE) | 路径参数 `id` | `snapshot` 与增量事件 | 在线状态、会话状态、队列、计时、投票实时变化 |
| `/interact/[sessionId]` | `/api/interact/sessions/[id]/status` | PATCH | `status=active|ended` | `session` | 教师开始/结束课堂控件 |
| `/interact/[sessionId]` | `/api/interact/sessions/[id]/hand` | POST | `action=raise|cancel` | `queue`, `position` | 学员举手/取消、队列反馈 |
| `/interact/[sessionId]` | `/api/interact/sessions/[id]/timer` | POST | `action=start|stop`, `speakerId`, `durationSec` | `timer` | 当前发言状态、教师点名/停表 |
| `/interact/[sessionId]` | `/api/interact/sessions/[id]/vote` | POST | `action=create|cast|close`, `pollId`, `selected` | `summary` | 投票题目、选项、票数、总票数 |
| `/interact/[sessionId]` | `/api/interact/sessions/[id]/kick` | POST | `userId`, `reason?` | `success` | 教师踢人操作 |
| `/interact/[sessionId]` | `/api/interact/sessions/[id]/mute` | POST | `globalMute` | `success` | 全员禁言开关 |

#### 4.3.1 SSE 字段冻结

1. `snapshot` 必含：`session`, `queue`, `activeTimer`, `openPoll`。
2. `queue[]`：`id`, `userId`, `nickname`, `status`, `raisedAt`。
3. `activeTimer`：`userId`, `nickname`, `durationSec`, `startedAt`。
4. `openPoll`：`pollId`, `question`, `type(single|multiple)`, `anonymous`, `status`, `options[]`, `totalVoters`。
5. `options[]`：`id`, `label`, `count`。
6. 最低事件处理：`snapshot`, `session_updated`, `settings_updated`, `user_kicked`。
7. 禁止改名字段（如 `openPoll` 改成 `poll`、`activeTimer` 改成 `timer`）。
8. 事件 payload 最低结构：
- `snapshot`: `{ session, queue, activeTimer, openPoll }`
- `session_updated`: `{ session }`
- `settings_updated`: `{ settings: { globalMute: boolean } }`
- `user_kicked`: `{ userId: number, reason?: string }`

#### 4.3.2 互动页面角色 UI 差异（强制）

1. 教师/管理员可见：创建课堂、开始/结束、点名、停表、踢人、禁言、发起/结束投票。
2. 学员可见：举手/取消举手、投票、查看队列与课堂状态。
3. 不允许把教师控件显示给学员角色。

### 4.4 作业、讨论、反馈

| 页面/场景 | 接口 | 方法 | 请求关键字段 | 响应关键字段 | 前台必须展示 |
|---|---|---|---|---|---|
| `/homework` | `/api/assignments` | GET | `all?` | `assignments[].lessonId,content,filePath,status,createdAt` | 列表、状态、时间、附件入口 |
| `/homework` | `/api/assignments` | POST | `lessonId`, `content?`, `file?` | `assignment` | 提交表单、附件限制、提交结果 |
| `/homework` | `/api/assignments/[id]/file` | GET | 路径参数 `id` | 文件流 | 附件下载 |
| `/discussion` | `/api/discussion/posts` | GET/POST | `title`, `content` | `posts[].title,content,nickname,commentCount,createdAt` | 帖子列表、作者、评论数、发帖 |
| `/discussion` | `/api/discussion/comments` | GET/POST | `postId`, `content` | `comments[].nickname,content,createdAt` | 评论列表、评论发送 |
| 课堂结束反馈入口（可嵌入 `/interact/[sessionId]` 或独立页） | `/api/feedbacks` | POST | `classSessionId?`, `rating?`, `content?`（至少一项） | `feedback.id,userId,classSessionId,rating,content,createdAt` | 评分控件、文本输入、提交反馈 |
| `/admin/feedbacks` | `/api/feedbacks` | GET | `classSessionId?`, `format?`, `limit?` | `feedbacks[].rating,content,classSessionTitle` | 反馈列表、筛选、CSV 导出 |

### 4.5 管理后台

| 页面 | 接口 | 方法 | 请求关键字段 | 响应关键字段 | 前台必须展示 |
|---|---|---|---|---|---|
| `/admin/users` | `/api/admin/users` | GET | `role?` | `users[].id,username,nickname,phone,role,createdAt` | 用户列表、角色筛选 |
| `/admin/users` | `/api/admin/users/[id]/role` | PATCH | `role` | `user.role` | 改角色控件 |
| `/admin/invites` | `/api/admin/invites` | GET/POST | `code?`, `targetRole`, `maxUses`, `expiresAt` | `invites[].code,targetRole,usedCount,maxUses,status,createdBy,createdAt` | 邀请码列表、创建、状态 |
| `/admin/invites` | `/api/admin/invites/[id]` | DELETE | 路径参数 `id` | `success` | 作废邀请码 |
| `/admin/assignments` | `/api/assignments?all=true` | GET | `all=true` | `assignments[].nickname,status,filePath` | 批阅列表 |
| `/admin/assignments` | `/api/assignments/[id]/review` | PATCH | `status=reviewed` | `assignment.status` | 标记已批阅 |
| `/admin/moderation` | `/api/admin/moderation/actions` | POST | `targetType,targetId,action,reason?` | `success,action` | 治理动作入口 |
| `/admin/moderation` | `/api/admin/moderation/logs` | GET | `targetType?`, `action?`, `limit?` | `logs[].operatorName,targetType,targetId,action,createdAt` | 治理日志 |
| `/admin/settings` | `/api/admin/settings` | GET/PATCH | `registrationEnabled`, `siteAnnouncement` | `settings` | 设置页展示与保存反馈 |

### 4.6 错误处理合同

1. 失败提示优先展示后端 `error.message`。
2. 最低覆盖错误码：
- `UNAUTHORIZED`, `FORBIDDEN`, `INVALID_INPUT`, `NOT_FOUND`, `STATE_INVALID`, `RATE_LIMITED`, `CONFLICT`, `INTERNAL_ERROR`
3. 该列表为最低覆盖，前端需有“未知错误码兜底提示”。
4. 禁止“假成功态”：后端失败时不可渲染成功文案。
5. 最低 HTTP 状态处理：
- `401`：跳转登录并保留 `callbackUrl`
- `403`：展示无权限提示（不伪装成功）
- `422`：展示状态冲突/参数不合法提示
- `429`：展示限流提示并短时禁用重复提交
- `5xx`：展示通用错误并允许重试

---

## 5. 可重构范围与设计系统要求

### 5.1 可重构范围（允许）

1. 全站视觉风格。
2. 页面布局结构与模块顺序。
3. 组件外观与交互动效。
4. 样式组织方式（Tailwind/CSS Modules/语义 CSS）。

### 5.2 不可降级要求

1. 不是仅换主题色，必须有版式和信息层级重构。
2. 全站风格一致，不出现新旧拼贴。
3. 保留教育场景与公共议事气质。
4. 移动端（375）与桌面端（1440）都可用。
5. 可访问性底线：键盘可达、焦点可见、文本可读。

### 5.3 共享组件职责（建议复用或等价替换）

| 组件 | 路径 | 职责 |
|---|---|---|
| `PageShell` | `components/page-shell.tsx` | 统一内页标题与内容框架 |
| `SiteNav` | `components/site-nav.tsx` | 主导航与角色入口 |
| `SiteFooter` | `components/site-footer.tsx` | 主站页脚 |
| `Providers` | `components/providers.tsx` | SessionProvider 容器 |
| `SessionView` | `components/interact/session-view.tsx` | 课堂互动主视图 |
| `HandRaiseQueue` | `components/interact/hand-raise-queue.tsx` | 举手队列 |
| `PollSystem` | `components/interact/poll-system.tsx` | 投票系统 |

---

## 6. 外发交付格式（不要求写入本仓库）

### 6.1 必交付内容

1. 方案摘要（目标、风格方向、关键取舍）。
2. 页面级改造清单（逐页保留功能与改造点）。
3. 组件级改造清单（新增/替换组件职责）。
4. 接口映射表（页面 -> 接口 -> 字段 -> 错误处理）。
5. 权限与重定向符合性说明。
6. 可接入代码结构与关键片段。
7. 集成步骤（路径、命令、注意事项）。
8. 自测与风险报告（构建/路由/流程/已知问题）。

### 6.2 推荐交付包结构

```text
frontend-redesign-delivery/
  README.md
  design-rationale.md
  route-mapping.md
  api-mapping.md
  permission-mapping.md
  integration-guide.md
  code/
    app/
    components/
    styles/
  qa/
    checklist.md
    screenshots/
```

### 6.3 严禁交付形式

1. 仅视觉描述，无可接入代码。
2. 仅截图，无功能映射与接口说明。
3. 伪代码为主，无法运行。

---

## 7. 外发提示词模板（可直接复制）

### 7.1 快速版（首轮沟通）

```text
你将为“议起读课程学习与互动平台”执行全站前端重设计。

硬约束：
1) 不改变业务语义/API 合同/权限规则/核心路由语义。
2) 不删除关键入口（注册、登录、邀请码、阅读、互动、作业、讨论、后台）。
3) 保持核心流程可用，构建通过（npm run build）。

目标：
1) 全站视觉与版式重构，不是仅换主题。
2) 形成可维护的设计系统（token + 语义层 + 组件层）。
3) 输出可接入代码包（无需直接提交我的仓库）。

输出：方案摘要、页面清单、组件清单、接口映射、权限映射、接入步骤、验收与风险。
```

### 7.2 完整版（推荐执行）

```text
你是一个资深前端工程团队，请为“议起读课程学习与互动平台”执行全站前端重设计。
目标是“功能冻结 + 视觉与前端实现重构”。

【强制输入资料】
1) docs/17-前端全站重设计外发约束文档.md
2) docs/18-前端重设计外发严格评审模板.md

【不可破坏约束】
1) 不改 API 路径、请求字段、响应字段、错误码语义。
2) 不改权限矩阵和重定向规则。
3) 不删关键入口与关键流程。
4) 不改 Route Group 结构语义。
5) 保持 proxy.ts 鉴权行为（含 /reading-legacy 静态保护）。

【实现约束】
1) 兼容 Next 16 + React 19 + Tailwind 4。
2) 严格遵守页面-接口-展示字段合同。
3) 严格遵守互动 SSE 字段与事件结构。
4) 错误态优先展示后端 error.message，禁止假成功。

【你的输出顺序】
1) 约束理解摘要（<=30 行）
2) 风险与阻断项
3) 页面改造清单
4) 组件改造清单
5) 接口映射表
6) 权限与重定向符合性表
7) 代码结构与关键代码
8) 集成步骤
9) 自测报告
10) 未完成项与后续建议

【每批提交必须附带】
1) 改动文件清单
2) 功能映射差异（旧入口 -> 新入口）
3) 回归结果（通过/失败 + 证据）
4) 风险与待办

如果你理解以上约束，请先返回“约束确认清单”，再开始输出方案。
```

---

## 8. 外发前自检（发包人）

1. 我是否附上了 docs/17 + docs/18 两份文档？
2. 我是否明确要求“先返回约束确认清单”？
3. 我是否要求其输出“接口映射表 + 权限符合性表”？
4. 我是否要求其报告“已知风险与未完成项”？

---

## 9. 与评审模板关系

1. 本文是“外发执行合同”。
2. `docs/18` 是“回收验收标准”。
3. 两者必须配套使用，缺一不可。
